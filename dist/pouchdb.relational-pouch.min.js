!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RelationalPouch=e()}}(function(){return function i(u,c,s){function a(t,e){if(!c[t]){if(!u[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(f)return f(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var o=c[t]={exports:{}};u[t][0].call(o.exports,function(e){return a(u[t][1][e]||e)},o,o.exports,i,u,c,s)}return c[t].exports}for(var f="function"==typeof require&&require,e=0;e<s.length;e++)a(s[e]);return a}({1:[function(e,t,n){"use strict";function r(){this.store={}}function o(){this.store=new r}n.Map=r,n.Set=o,r.prototype.mangle=function(e){if("string"!=typeof e)throw new TypeError("key must be a string but Got "+e);return"$"+e},r.prototype.unmangle=function(e){return e.substring(1)},r.prototype.get=function(e){var t=this.mangle(e);return t in this.store?this.store[t]:void 0},r.prototype.set=function(e,t){var n=this.mangle(e);return this.store[n]=t,!0},r.prototype.has=function(e){return this.mangle(e)in this.store},r.prototype.delete=function(e){var t=this.mangle(e);return t in this.store&&(delete this.store[t],!0)},r.prototype.forEach=function(n){var r=this;Object.keys(r.store).forEach(function(e){var t=r.store[e];e=r.unmangle(e),n(t,e)})},o.prototype.add=function(e){return this.store.set(e,!0)},o.prototype.has=function(e){return this.store.has(e)},o.prototype.delete=function(e){return this.store.delete(e)}},{}],2:[function(e,t,n){"use strict";var p=e("./pouch-utils"),d=p.extend,v=p.Promise,y=e("./collections"),r=e("./uuid"),m=e("uniq");var o=16,i="0",u="1",c="2",s="3";function g(e,t){var n=e.replace("_","")+"_";if("number"==typeof t){for(t=t.toString();t.length<o;)t="0"+t;n+=u+"_"+t}else n+=void 0===t?i:"object"==typeof t?s:c+"_"+t;return n}function w(e){var t=e.indexOf("_"),n=e.charAt(t+1),r=e.substring(t+3);return n===u?parseInt(r,10):r}n.setSchema=function(i){var c=this,u=new y.Map;function s(i,u){var e={};(u=d(!0,{},u)).rev&&(e._rev=u.rev,delete u.rev),u.attachments&&(e._attachments=u.attachments,delete u.attachments);var t=u.id||r();return delete u.id,e._id=g(i.documentType,t),i.relations&&Object.keys(i.relations).forEach(function(e){var t=i.relations[e],n=Object.keys(t)[0];if("belongsTo"===n)u[e]&&void 0!==u[e].id&&(u[e]=u[e].id);else{var r=t[n];if(r.options&&r.options.queryInverse)return void delete u[e];if(u[e]){var o=u[e].map(function(e){return e&&void 0!==e.id?e.id:e});u[e]=o}else u[e]=[]}}),e.data=u,e}function l(e){if(!u.has(e))throw t="unknown type: "+JSON.stringify(e),(n=new Error(t)).status=400,n;var t,n;return u.get(e)}function o(e,t,n){var r=l(e),o={include_docs:!0};return null==t?(o.startkey=g(r.documentType),o.endkey=g(r.documentType,{})):Array.isArray(t)?o.keys=t.map(function(e){return g(r.documentType,e)}):"object"==typeof t?(void 0===t.startkey||null===t.startkey?o.startkey=g(r.documentType):o.startkey=g(r.documentType,t.startkey),void 0===t.endkey||null===t.endkey?o.endkey=g(r.documentType,{}):o.endkey=g(r.documentType,t.endkey),void 0!==t.limit&&null!==t.limit&&(o.limit=t.limit),void 0!==t.skip&&null!==t.skip&&(o.skip=t.skip)):o.key=g(r.documentType,t),c.allDocs(o).then(function(e,t,n){return a(e,t,n.rows.filter(function(e){return e.doc&&!e.value.deleted}).map(function(e){return e.doc}))}.bind(c,e,n))}function a(r,a,t){var f=l(r);return a.has(r)||a.set(r,new y.Map),v.resolve().then(function(){var e=t.map(function(e){var t,n,c=((n=(t=e).data).id=w(t._id),n.rev=t._rev,t._attachments&&(n.attachments=t._attachments),n);a.get(r).set(JSON.stringify(c.id),c);var s=[];return Object.keys(f.relations||{}).forEach(function(e){var t=f.relations[e],n=Object.keys(t)[0],r=t[n],o={};if("string"!=typeof r){if((o=r.options||{}).async)return;o.queryInverse&&delete c[e],r=r.type}if("belongsTo"===n){var i=c[e];void 0!==i&&s.push(v.resolve().then(function(){if(!a.has(r)||!a.get(r).has(JSON.stringify(i)))return{relatedType:r,relatedIds:[i]}}))}else{if(o.queryInverse)return void s.push(h(r,o.queryInverse,c.id,a).then(function(){}));var u=d(!0,[],c[e]);void 0!==u&&u.length&&s.push(v.resolve().then(function(){for(var e=u.length-1;0<=e;e--){var t=u[e];a.has(r)&&a.get(r).has(JSON.stringify(t))&&delete u[e]}if((u=u.filter(function(e){return void 0!==e})).length)return{relatedType:r,relatedIds:u}}))}}),v.all(s)});return v.all(e)}).then(function(e){var n={};return e.forEach(function(e){e.forEach(function(e){e&&(n[e.relatedType]=(n[e.relatedType]||[]).concat(e.relatedIds))})}),p.series(Object.keys(n).map(function(e){var t=m(n[e]);return function(){return o(e,t,a)}})).then(function(){var o={};return a.forEach(function(e,t){var n=l(t),r=o[n.plural]=[];e.forEach(function(e){r.push(e)})}),o})})}function h(t,e,n,r){var o={_id:{$gt:f({type:t}),$lt:f({type:t,id:{}})}};return o["data."+e]=n,c.find({selector:o}).then(function(e){return a(t,r,e.docs)})}function f(e){var t=e.type,n=u.get(t);return n&&(t=n.documentType),g(t,e.id)}i.forEach(function(e){u.set(e.singular,e),u.set(e.plural,e)}),i.forEach(function(e){e.documentType=e.documentType||e.singular}),i.forEach(function(o){if(o.relations){if(!Object.keys(o.relations).length)throw new Error("Invalid relations for: "+o);Object.keys(o.relations).forEach(function(e){var t=o.relations[e];if(1!==Object.keys(t).length)throw new Error("Invalid relationship definition for: "+e);var n=Object.keys(t)[0],r=t[n];if("string"!=typeof r&&(r=r.type),!u.get(r))throw new Error("Unknown entity type: "+r);if("belongsTo"!==n&&"hasMany"!==n)throw new Error("Invalid relationship type for "+e+": "+n)})}}),c.rel={save:function(t,o){return v.resolve().then(function(){return n=o,r=l(t),v.resolve().then(function(){return e=s(r,n),c.put(e)}).then(function(e){var t={};return t[r.plural]=[d(!0,n,{id:w(e.id),rev:e.rev})],t});var n,e,r})},find:function(e,t){return v.resolve().then(function(){return o(l(e).singular,t,new y.Map)})},findHasMany:function(e,t,n){return h(e,t,n,new y.Map)},del:function(r,o){return v.resolve().then(function(){return e=o,n=l(r),v.resolve().then(function(){return t={_id:(t=s(n,e))._id,_rev:t._rev,_deleted:!0},c.put(t)}).then(function(){return{deleted:!0}});var e,t,n})},getAttachment:function(e,t,n,r){return r=r||{},v.resolve().then(function(){return c.getAttachment(g(e,t),n,r)})},putAttachment:function(e,n,t,r,o){var i=g(e,n.id),u=l(e);return v.resolve().then(function(){return c.putAttachment(i,t,n.rev,r,o)}).then(function(e){var t={};return t[u.plural]=[d(!0,n,{id:w(e.id),rev:e.rev})],t})},removeAttachment:function(e,n,t){var r=g(e,n.id),o=l(e);return v.resolve().then(function(){return c.removeAttachment(r,t,n.rev)}).then(function(e){var t={};return t[o.plural]=[d(!0,n,{id:w(e.id),rev:e.rev})],t})},parseDocID:function(e){var t=e.indexOf("_"),n=e.substring(0,t),r=w(e);if(!u.get(n)){var o=i.filter(function(e){return e.documentType===n});0<o.length&&(n=o[0].singular)}return{type:n,id:r}},makeDocID:f,parseRelDocs:function(e,t){return a(e,new y.Map,t)},isDeleted:function(e,t){var n=l(e);return c.get(g(n.documentType,t)).then(function(e){return!!e._deleted}).catch(function(e){return"deleted"===e.reason||null})},uuid:r}},"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(n)},{"./collections":1,"./pouch-utils":5,"./uuid":6,uniq:11}],3:[function(e,t,n){"use strict";t.exports=function e(t){var n,r,o;if(!t||"object"!=typeof t)return t;if(Array.isArray(t)){for(n=[],r=0,o=t.length;r<o;r++)n[r]=e(t[r]);return n}if(t instanceof Date)return t.toISOString();if(!function(e){if("function"!=typeof e.hasOwnProperty)return!1;var t;for(t in e);return void 0===t||e.hasOwnProperty(t)}(t))return t;for(r in n={},t)if(t.hasOwnProperty(r)){var i=e(t[r]);void 0!==i&&(n[r]=i)}return n}},{}],4:[function(e,t,n){"use strict";var o=e("./pouch-clone");function r(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=o(t[n]);void 0!==r&&(e[n]=r)}}t.exports=function(e,t,n){return r(e,t),n&&r(e,n),e}},{"./pouch-clone":3}],5:[function(n,e,s){(function(u){"use strict";var e,t=(e=n("lie"))&&"object"==typeof e&&"default"in e?e.default:e,c="function"==typeof c?c:t;s.once=function(t){var n=!1;return s.getArguments(function(e){if(n)throw console.trace(),new Error("once called  more than once");n=!0,t.apply(this,e)})},s.getArguments=function(r){return function(){for(var e=arguments.length,t=new Array(e),n=-1;++n<e;)t[n]=arguments[n];return r.call(this,t)}},s.toPromise=function(i){return s.getArguments(function(t){var n,o=this,r="function"==typeof t[t.length-1]&&t.pop();r&&(n=function(e,t){u.nextTick(function(){r(e,t)})});var e=new c(function(n,r){try{var e=s.once(function(e,t){e?r(e):n(t)});t.push(e),i.apply(o,t)}catch(e){r(e)}});return n&&e.then(function(e){n(null,e)},n),e.cancel=function(){return this},e})},s.series=function(n){var r=s.Promise.resolve(),o=new Array(n.length);return n.forEach(function(e,t){r=r.then(n[t]).then(function(e){o[t]=e})}),r.then(function(){return o})},s.inherits=n("inherits"),s.Promise=c,s.extend=n("./pouch-extend")}).call(this,n("_process"))},{"./pouch-extend":4,_process:10,inherits:8,lie:9}],6:[function(e,t,n){"use strict";var o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");function i(e){return 0|Math.random()*e}t.exports=function(e,t){t=t||o.length;var n="",r=-1;if(e){for(;++r<e;)n+=o[i(t)];return n}for(;++r<36;)switch(r){case 8:case 13:case 18:case 23:n+="-";break;case 19:n+=o[3&i(16)|8];break;default:n+=o[i(16)]}return n}},{}],7:[function(e,f,t){(function(t){"use strict";var n,r,e=t.MutationObserver||t.WebKitMutationObserver;if(e){var o=0,i=new e(a),u=t.document.createTextNode("");i.observe(u,{characterData:!0}),n=function(){u.data=o=++o%2}}else if(t.setImmediate||void 0===t.MessageChannel)n="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){a(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(a,0)};else{var c=new t.MessageChannel;c.port1.onmessage=a,n=function(){c.port2.postMessage(0)}}var s=[];function a(){var e,t;r=!0;for(var n=s.length;n;){for(t=s,s=[],e=-1;++e<n;)t[e]();n=s.length}r=!1}f.exports=function(e){1!==s.push(e)||r||n()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],8:[function(e,t,n){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},{}],9:[function(e,t,n){"use strict";var o=e("immediate");function a(){}var f={},i=["REJECTED"],u=["FULFILLED"],r=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=r,this.queue=[],this.outcome=void 0,e!==a&&p(this,e)}function s(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function l(t,n,r){o(function(){var e;try{e=n(r)}catch(e){return f.reject(t,e)}e===t?f.reject(t,new TypeError("Cannot resolve promise with itself")):f.resolve(t,e)})}function h(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(t,e){var n=!1;function r(e){n||(n=!0,f.reject(t,e))}function o(e){n||(n=!0,f.resolve(t,e))}var i=d(function(){e(o,r)});"error"===i.status&&r(i.value)}function d(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}(t.exports=c).prototype.finally=function(t){if("function"!=typeof t)return this;var n=this.constructor;return this.then(function(e){return n.resolve(t()).then(function(){return e})},function(e){return n.resolve(t()).then(function(){throw e})})},c.prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===u||"function"!=typeof t&&this.state===i)return this;var n=new this.constructor(a);this.state!==r?l(n,this.state===u?e:t,this.outcome):this.queue.push(new s(n,e,t));return n},s.prototype.callFulfilled=function(e){f.resolve(this.promise,e)},s.prototype.otherCallFulfilled=function(e){l(this.promise,this.onFulfilled,e)},s.prototype.callRejected=function(e){f.reject(this.promise,e)},s.prototype.otherCallRejected=function(e){l(this.promise,this.onRejected,e)},f.resolve=function(e,t){var n=d(h,t);if("error"===n.status)return f.reject(e,n.value);var r=n.value;if(r)p(e,r);else{e.state=u,e.outcome=t;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(t)}return e},f.reject=function(e,t){e.state=i,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e},c.resolve=function(e){if(e instanceof this)return e;return f.resolve(new this(a),e)},c.reject=function(e){var t=new this(a);return f.reject(t,e)},c.all=function(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,o=!1;if(!r)return this.resolve([]);var i=new Array(r),u=0,t=-1,c=new this(a);for(;++t<r;)s(e[t],t);return c;function s(e,t){n.resolve(e).then(function(e){i[t]=e,++u!==r||o||(o=!0,f.resolve(c,i))},function(e){o||(o=!0,f.reject(c,e))})}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,r=!1;if(!n)return this.resolve([]);var o=-1,i=new this(a);for(;++o<n;)u=e[o],t.resolve(u).then(function(e){r||(r=!0,f.resolve(i,e))},function(e){r||(r=!0,f.reject(i,e))});var u;return i}},{immediate:7}],10:[function(e,t,n){var r,o,i=t.exports={};function u(){throw new Error("setTimeout has not been defined")}function c(){throw new Error("clearTimeout has not been defined")}function s(t){if(r===setTimeout)return setTimeout(t,0);if((r===u||!r)&&setTimeout)return r=setTimeout,setTimeout(t,0);try{return r(t,0)}catch(e){try{return r.call(null,t,0)}catch(e){return r.call(this,t,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:u}catch(e){r=u}try{o="function"==typeof clearTimeout?clearTimeout:c}catch(e){o=c}}();var a,f=[],l=!1,h=-1;function p(){l&&a&&(l=!1,a.length?f=a.concat(f):h=-1,f.length&&d())}function d(){if(!l){var e=s(p);l=!0;for(var t=f.length;t;){for(a=f,f=[];++h<t;)a&&a[h].run();h=-1,t=f.length}a=null,l=!1,function(t){if(o===clearTimeout)return clearTimeout(t);if((o===c||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(t);try{o(t)}catch(e){try{return o.call(null,t)}catch(e){return o.call(this,t)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function y(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];f.push(new v(e,t)),1!==f.length||l||s(d)},v.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=y,i.addListener=y,i.once=y,i.off=y,i.removeListener=y,i.removeAllListeners=y,i.emit=y,i.prependListener=y,i.prependOnceListener=y,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}],11:[function(e,t,n){"use strict";t.exports=function(e,t,n){return 0===e.length?e:t?(n||e.sort(t),function(e,t){for(var n=1,r=e.length,o=e[0],i=e[0],u=1;u<r;++u)if(i=o,t(o=e[u],i)){if(u===n){n++;continue}e[n++]=o}return e.length=n,e}(e,t)):(n||e.sort(),function(e){for(var t=1,n=e.length,r=e[0],o=e[0],i=1;i<n;++i,o=r)if(o=r,(r=e[i])!==o){if(i===t){t++;continue}e[t++]=r}return e.length=t,e}(e))}},{}]},{},[2])(2)});
